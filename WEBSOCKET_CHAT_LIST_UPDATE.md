# èŠå¤©åˆ—è¡¨è‡ªåŠ¨æ›´æ–°åŠŸèƒ½

## åŠŸèƒ½æ¦‚è¿°

å®ç°äº†èŠå¤©åˆ—è¡¨çš„å®æ—¶è‡ªåŠ¨æ›´æ–°åŠŸèƒ½ï¼Œå½“åˆ›å»ºæ–°å¯¹è¯æˆ–æœ‰æ–°æ¶ˆæ¯æ—¶ï¼Œç›¸å…³ç”¨æˆ·çš„èŠå¤©åˆ—è¡¨ä¼šè‡ªåŠ¨åˆ·æ–°ï¼Œæ— éœ€æ‰‹åŠ¨åˆ·æ–°é¡µé¢ã€‚

## å®ç°åŸç†

### å‰ç«¯å®ç° (Message.tsx)

1. **WebSocketè¿æ¥ç®¡ç†**
   - åœ¨ç»„ä»¶åŠ è½½æ—¶è‡ªåŠ¨è¿æ¥WebSocket
   - ç›‘å¬å¯¹è¯åˆ›å»ºå’Œæ›´æ–°äº‹ä»¶
   - æ˜¾ç¤ºè¿æ¥çŠ¶æ€æŒ‡ç¤ºå™¨

2. **äº‹ä»¶ç›‘å¬**

   ```typescript
   // ç›‘å¬å¯¹è¯åˆ›å»º/æ›´æ–°äº‹ä»¶
   WebSocketService.addEventListener(
     "conversation_created",
     handleConversationUpdate
   );
   WebSocketService.addEventListener(
     "conversation_updated",
     handleConversationUpdate
   );
   WebSocketService.addEventListener("message", handleNewMessage);
   ```

3. **é˜²æŠ–åˆ·æ–°æœºåˆ¶**
   - é¿å…é¢‘ç¹åˆ·æ–°å¯¼è‡´çš„æ€§èƒ½é—®é¢˜
   - 1ç§’å»¶è¿Ÿåˆå¹¶å¤šä¸ªæ›´æ–°è¯·æ±‚
   - è‡ªåŠ¨æ¸…ç†å®šæ—¶å™¨é¿å…å†…å­˜æ³„æ¼

### åç«¯å®ç° (server/src/index.ts + message.ts)

1. **WebSocketå¹¿æ’­åŠŸèƒ½**

   ```typescript
   // å¹¿æ’­å¯¹è¯åˆ›å»ºäº‹ä»¶
   export function broadcastConversationCreated(conversationData: any);

   // å¹¿æ’­å¯¹è¯æ›´æ–°äº‹ä»¶
   export function broadcastConversationUpdated(conversationData: any);
   ```

2. **APIé›†æˆ**
   - åˆ›å»ºå¯¹è¯æ—¶å¹¿æ’­ `conversation_created` äº‹ä»¶
   - å‘é€æ¶ˆæ¯æ—¶å¹¿æ’­ `conversation_updated` äº‹ä»¶
   - å‘å¯¹è¯æ‰€æœ‰å‚ä¸è€…å‘é€é€šçŸ¥

## è§¦å‘åœºæ™¯

### 1. åˆ›å»ºæ–°å¯¹è¯

- **è§¦å‘æ—¶æœº**ï¼šç”¨æˆ·é€šè¿‡"å¼€å§‹æ–°èŠå¤©"åˆ›å»ºå¯¹è¯
- **å¹¿æ’­äº‹ä»¶**ï¼š`conversation_created`
- **å½±å“ç”¨æˆ·**ï¼šå¯¹è¯ä¸­çš„æ‰€æœ‰å‚ä¸è€…
- **æ›´æ–°å†…å®¹**ï¼šèŠå¤©åˆ—è¡¨æ–°å¢å¯¹è¯

### 2. å‘é€æ¶ˆæ¯

- **è§¦å‘æ—¶æœº**ï¼šåœ¨ä»»ä½•å¯¹è¯ä¸­å‘é€æ¶ˆæ¯
- **å¹¿æ’­äº‹ä»¶**ï¼š`conversation_updated`
- **å½±å“ç”¨æˆ·**ï¼šå¯¹è¯ä¸­çš„æ‰€æœ‰å‚ä¸è€…
- **æ›´æ–°å†…å®¹**ï¼šèŠå¤©åˆ—è¡¨ä¸­çš„æœ€åæ¶ˆæ¯å’Œæ—¶é—´

### 3. å®æ—¶æ¶ˆæ¯

- **è§¦å‘æ—¶æœº**ï¼šæ¥æ”¶åˆ°å®æ—¶æ¶ˆæ¯
- **å¹¿æ’­äº‹ä»¶**ï¼š`message`
- **å½±å“ç”¨æˆ·**ï¼šæ¶ˆæ¯æ¥æ”¶è€…
- **æ›´æ–°å†…å®¹**ï¼šèŠå¤©åˆ—è¡¨æ’åºå’Œæœ€åæ¶ˆæ¯

## ç”¨æˆ·ä½“éªŒ

### çŠ¶æ€æŒ‡ç¤ºå™¨

- **ç»¿è‰²åœ†ç‚¹ + "å®æ—¶"**ï¼šWebSocketè¿æ¥æ­£å¸¸ï¼Œæ”¯æŒå®æ—¶æ›´æ–°
- **çº¢è‰²åœ†ç‚¹ + "ç¦»çº¿"**ï¼šWebSocketè¿æ¥å¤±è´¥ï¼Œéœ€è¦æ‰‹åŠ¨åˆ·æ–°

### è‡ªåŠ¨æ›´æ–°æµç¨‹

1. ç”¨æˆ·Aåˆ›å»ºä¸ç”¨æˆ·Bçš„å¯¹è¯
2. ç”¨æˆ·Bçš„èŠå¤©åˆ—è¡¨è‡ªåŠ¨å‡ºç°æ–°å¯¹è¯
3. ç”¨æˆ·Aå‘é€æ¶ˆæ¯
4. ç”¨æˆ·Bçš„èŠå¤©åˆ—è¡¨è‡ªåŠ¨æ›´æ–°æœ€åæ¶ˆæ¯
5. æ— éœ€ä»»ä½•æ‰‹åŠ¨æ“ä½œ

## æ€§èƒ½ä¼˜åŒ–

### 1. é˜²æŠ–æœºåˆ¶

```typescript
const debouncedRefreshChatList = () => {
  if (refreshTimeoutRef.current) {
    clearTimeout(refreshTimeoutRef.current);
  }

  refreshTimeoutRef.current = setTimeout(() => {
    loadChatList();
  }, 1000); // 1ç§’å»¶è¿Ÿ
};
```

### 2. é”™è¯¯å¤„ç†

- WebSocketè¿æ¥å¤±è´¥æ—¶ä¸å½±å“åŸºæœ¬åŠŸèƒ½
- é™é»˜å¤„ç†å¹¿æ’­é”™è¯¯ï¼Œä¸å½±å“APIå“åº”
- è‡ªåŠ¨é‡è¿æœºåˆ¶ç¡®ä¿ç¨³å®šæ€§

### 3. å†…å­˜ç®¡ç†

- ç»„ä»¶å¸è½½æ—¶æ¸…ç†äº‹ä»¶ç›‘å¬å™¨
- æ¸…ç†å®šæ—¶å™¨é˜²æ­¢å†…å­˜æ³„æ¼
- åˆç†çš„äº‹ä»¶è®¢é˜…/å–æ¶ˆæœºåˆ¶

## æ‰©å±•åŠŸèƒ½

### å½“å‰æ”¯æŒ

- âœ… å¯¹è¯åˆ›å»ºå®æ—¶é€šçŸ¥
- âœ… æ¶ˆæ¯å‘é€å®æ—¶æ›´æ–°
- âœ… è¿æ¥çŠ¶æ€æ˜¾ç¤º
- âœ… é˜²æŠ–åˆ·æ–°æœºåˆ¶
- âœ… é”™è¯¯å›é€€å¤„ç†

### æœªæ¥æ‰©å±•

- ğŸ”„ æœªè¯»æ¶ˆæ¯è®¡æ•°å®æ—¶æ›´æ–°
- ğŸ”„ ç”¨æˆ·åœ¨çº¿çŠ¶æ€å®æ—¶æ˜¾ç¤º
- ğŸ”„ æ¶ˆæ¯å·²è¯»çŠ¶æ€åŒæ­¥
- ğŸ”„ ç¾¤ç»„å¯¹è¯æ”¯æŒ
- ğŸ”„ æ¶ˆæ¯æ’¤å›é€šçŸ¥

## æŠ€æœ¯ç»†èŠ‚

### WebSocketäº‹ä»¶æ ¼å¼

```typescript
// å¯¹è¯åˆ›å»ºäº‹ä»¶
{
  type: "conversation_created",
  data: {
    conversationId: string,
    participants: string[],
    participantDetails: User[],
    isNew: boolean,
    timestamp: number
  }
}

// å¯¹è¯æ›´æ–°äº‹ä»¶
{
  type: "conversation_updated",
  data: {
    conversationId: string,
    participants: string[],
    lastMessage: Message,
    timestamp: number
  }
}
```

### ä¾èµ–å…³ç³»

- å‰ç«¯ï¼šReact Hooks, WebSocket Service
- åç«¯ï¼šExpress.js, WebSocket Server, MongoDB
- é€šä¿¡ï¼šå®æ—¶WebSocket + HTTP API

è¿™ä¸ªå®ç°ç¡®ä¿äº†èŠå¤©åˆ—è¡¨çš„å®æ—¶æ€§å’Œç”¨æˆ·ä½“éªŒçš„æµç•…æ€§ï¼ŒåŒæ—¶ä¿æŒäº†ç³»ç»Ÿçš„ç¨³å®šæ€§å’Œæ€§èƒ½ã€‚
